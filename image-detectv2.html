<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AABB 比例数值验证（只改 Width）</title>
<style>
  :root { --fg:#111; --bg:#fafafa; --muted:#666; --border:#e9e9e9; }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:780px;margin:32px auto;padding:24px;background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:0 1px 4px rgba(0,0,0,.04)}
  h1{margin:0 0 16px;font-size:20px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .row{display:flex;gap:12px;align-items:center}
  label{min-width:120px;color:var(--muted)}
  input[type=text],input[type=number]{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:8px}
  button{padding:10px 14px;border:1px solid var(--border);border-radius:8px;background:#111;color:#fff;cursor:pointer}
  button.secondary{background:#fff;color:#111}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .card{border:1px solid var(--border);border-radius:10px;padding:12px;background:#fff}
  .ok{color:#0a7a35}.warn{color:#b35300}.err{color:#c21807}
  .small{font-size:13px;color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <h1>只改 Width，使投影 AABB 的 W/H = 目标比例（正交相机，yaw/pitch，无 roll）</h1>

    <div class="grid">
      <div class="card">
        <div class="row">
          <label for="ratio">目标比例 W/H</label>
          <input id="ratio" type="text" value="1:2" class="mono" placeholder="例如 3:2 或 1.5">
        </div>
        <div class="row">
          <label>旋转（度）</label>
          <input id="pitch" type="number" step="0.1" class="mono" value="15" title="pitch 绕 X（度）">
          <input id="yaw"   type="number" step="0.1" class="mono" value="30" title="yaw 绕 Y（度）">
        </div>
        <div class="row" style="gap:8px;margin-top:6px">
          <button id="btnRand" class="secondary">随机旋转</button>
          <button id="btnSolve">计算 width</button>
        </div>
        <p class="small">固定尺寸：Height=2、Depth=2（half：hy=1、hz=1）。只改 Width（half：hx）。旋转顺序使用矩阵 <span class="mono">R = R<sub>yaw</sub> · R<sub>pitch</sub></span>。</p>
      </div>

      <div class="card">
        <div class="row"><label>求解的 hx</label><div id="hx" class="mono">—</div></div>
        <div class="row"><label>新的 Width</label><div id="width" class="mono">—</div></div>
        <div class="row"><label>分母检查</label><div id="den" class="mono">—</div></div>
        <hr>
        <div class="row"><label>回算 W/H</label><div id="wh" class="mono">—</div></div>
        <div class="row"><label>目标 t</label><div id="t" class="mono">—</div></div>
        <div class="row"><label>相对误差</label><div id="err" class="mono">—</div></div>
        <div id="status" class="small">—</div>
      </div>
    </div>
  </div>

<script>
(function(){
  // 常量：只改 Width，Height=2, Depth=2
  const hy = 1, hz = 1;

  const el = id => document.getElementById(id);
  const ratioEl = el('ratio');
  const pitchEl = el('pitch');
  const yawEl = el('yaw');
  const hxOut = el('hx');
  const widthOut = el('width');
  const denOut = el('den');
  const whOut = el('wh');
  const tOut = el('t');
  const errOut = el('err');
  const statusEl = el('status');

  function parseRatio(str){
    str = String(str).trim();
    if(!str) return NaN;
    if(str.includes(':')){
      const [a,b] = str.split(':').map(Number);
      if(isFinite(a) && isFinite(b) && b !== 0) return a/b;
      return NaN;
    }else{
      const v = Number(str);
      return isFinite(v) ? v : NaN;
    }
  }

  function deg2rad(d){ return d * Math.PI / 180; }

  // 旋转矩阵 R = Ry * Rx （不绕 Z）
  // Ry(yaw) = [[ cy, 0, sy],
  //             [  0, 1,  0],
  //             [-sy, 0, cy]]
  // Rx(pitch)= [[1, 0,  0],
  //             [0, cx,-sx],
  //             [0, sx, cx]]
  function rotAbsElements(pitchDeg, yawDeg){
    const px = deg2rad(pitchDeg);
    const py = deg2rad(yawDeg);
    const cx = Math.cos(px), sx = Math.sin(px);
    const cy = Math.cos(py), sy = Math.sin(py);

    // R = Ry * Rx
    const R00 =  cy;
    const R01 =  sy * sx;
    const R02 =  sy * cx;

    const R10 =  0;
    const R11 =  cx;
    const R12 = -sx;

    const R20 = -sy;
    const R21 =  cy * sx;
    const R22 =  cy * cx;

    return {
      a00: Math.abs(R00), a01: Math.abs(R01), a02: Math.abs(R02),
      a10: Math.abs(R10), a11: Math.abs(R11), a12: Math.abs(R12),
      a20: Math.abs(R20), a21: Math.abs(R21), a22: Math.abs(R22),
      // 也返回便于调试
      raw: {R00,R01,R02,R10,R11,R12,R20,R21,R22}
    };
  }

  function solve(){
    const t = parseRatio(ratioEl.value);
    const pitch = Number(pitchEl.value);
    const yaw = Number(yawEl.value);

    if(!isFinite(t) || t <= 0){
      statusEl.innerHTML = '<span class="err">无效的比例（请输入 "a:b" 或正小数）。</span>';
      resetOutputs();
      return;
    }

    const {a00,a01,a02,a10,a11,a12} = rotAbsElements(pitch, yaw);

    // A,B 与分母（公式：hx = (tB - A) / (a00 - t*a10)）
    const A = a01*hy + a02*hz;
    const B = a11*hy + a12*hz;
    const denom = (a00 - t * a10);

    denOut.textContent = denom.toFixed(6);
    tOut.textContent = t.toFixed(6);

    const EPS = 1e-8;

    if(Math.abs(denom) < EPS){
      statusEl.innerHTML = '<span class="warn">该姿态下分母≈0，仅靠改 Width 无法达到该比例（需要无限大或未定义）。请随机另一个旋转。</span>';
      resetOutputs();
      return;
    }

    const hx = (t * B - A) / denom;
    const width = 2 * hx;

    if(!(isFinite(hx) && hx > 0)){
      statusEl.innerHTML = '<span class="warn">解出的 hx ≤ 0 或非有限值，此姿态下目标比例不可行。请随机另一个旋转。</span>';
      resetWHOutputs(width, hx, t, NaN, NaN);
      return;
    }

    // 用 AABB 公式回算 W/H
    const W = 2 * (a00*hx + A);
    const H = 2 * (a10*hx + B);
    const wh = W / H;
    const relErr = Math.abs(wh - t) / t;

    // 输出
    hxOut.textContent = hx.toFixed(6);
    widthOut.textContent = width.toFixed(6);
    whOut.textContent = wh.toFixed(6);
    errOut.textContent = (relErr*100).toFixed(4) + '%';

    // 状态
    if(relErr < 5e-3){ // 0.5% 容差
      statusEl.innerHTML = '<span class="ok">OK：在 0.5% 容差内。</span>';
    }else{
      statusEl.innerHTML = '<span class="warn">已计算，但误差偏大（>0.5%）。可检查实现或放宽容差。</span>';
    }
  }

  function resetOutputs(){
    hxOut.textContent = '—';
    widthOut.textContent = '—';
    whOut.textContent = '—';
    errOut.textContent = '—';
  }
  function resetWHOutputs(width,hx,t,wh,err){
    hxOut.textContent = isFinite(hx)?hx:'—';
    widthOut.textContent = isFinite(width)?width:'—';
    whOut.textContent = isFinite(wh)?wh:'—';
    errOut.textContent = isFinite(err)?err:'—';
  }

  function randRot(){
    // 随机 pitch,yaw；限制到较直观范围
    const yaw = (Math.random()*360 - 180);      // [-180,180)
    const pitch = (Math.random()*180 - 90);     // [-90,90)
    yawEl.value = yaw.toFixed(2);
    pitchEl.value = pitch.toFixed(2);
    statusEl.textContent = '已生成随机旋转。';
  }

  el('btnSolve').addEventListener('click', solve);
  el('btnRand').addEventListener('click', ()=>{ randRot(); });

  // 首次自动算一次
  solve();
})();
</script>
</body>
</html>
